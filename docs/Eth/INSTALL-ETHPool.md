Install BTC.COM Pool
=====================

**Supported OS**
* `Ubuntu 14.04 LTS, 64 Bits`
* `Ubuntu 16.04 LTS, 64 Bits`
* `macOS Sierra or later`

**BTCPool has a known compatibility issue with 32-bit operating systems. https://github.com/btccom/btcpool/issues/38**

If you want to run BTCPool on a 32-bit operating system, you must fix the problem first. Or, choose a 64-bit operating system.

## Build

[Need fix] If you are the first time build btcpool, you could run `bash install/install_btcpool.sh` instead of exec these shell commands one by one.

```
cd /work
wget https://raw.githubusercontent.com/btccom/btcpool/master/install/install_btcpool.sh
bash ./install_btcpool.sh
```

### Install dependency

#### Ubuntu
```bash
apt-get update
apt-get install -y build-essential autotools-dev libtool autoconf automake pkg-config cmake \
                   openssl libssl-dev libcurl4-openssl-dev libconfig++-dev \
                   libboost-all-dev libgmp-dev libmysqlclient-dev libzookeeper-mt-dev \
                   libzmq3-dev libgoogle-glog-dev libevent-dev libhiredis-dev
```

Sometimes one or two packages will fail due to dependency problems, and you can try `aptitude`.
```bash
apt-get update
apt-get install -y aptitude

aptitude install build-essential autotools-dev libtool autoconf automake pkg-config cmake \
                   openssl libssl-dev libcurl4-openssl-dev libconfig++-dev \
                   libboost-all-dev libgmp-dev libmysqlclient-dev libzookeeper-mt-dev \
                   libzmq3-dev libgoogle-glog-dev libevent-dev libhiredis-dev

# Input `n` if the solution is `NOT INSTALL` some package.
# Eventually aptitude will give a solution that downgrade some packages to allow all packages to be installed.
```

* librdkafka-v0.9.1

```bash
apt-get install -y zlib1g zlib1g-dev
mkdir -p /root/source && cd /root/source
wget https://github.com/edenhill/librdkafka/archive/0.9.1.tar.gz
tar zxvf 0.9.1.tar.gz
cd librdkafka-0.9.1
./configure && make && make install
```

* ethereum

```bash
sudo add-apt-repository -y ppa:ethereum/ethereum
sudo apt-get update
sudo apt-get install ethereum
```

#### macOS

Please install [brew](https://brew.sh/) first.

```bash
brew install cmake openssl libconfig boost mysql zmq gmp libevent zookeeper librdkafka libhiredis
```

* glog-v0.3.4

```
mkdir -p /root/source && cd /root/source
wget https://github.com/google/glog/archive/v0.3.4.tar.gz
tar zxvf v0.3.4.tar.gz
cd glog-0.3.4
./configure && make && make install
```

### Build BTCPool

#### CMake Options

There are some cmake options that can change the behavior of compiler,
enable or disable optional features of BTCPool,
or link BTCPool with different blockchains.

|   Option Name    |     Values     | Default Value |   Description  |
|         -        |        -       |      -        |        -       |
| CMAKE_BUILD_TYPE | Release, Debug |    Release    |   Build type   |
| JOBS | A number, between 1 to your CPU cores' number. | 1 | Concurrent jobs when building blockchain's source code that linking to BTCPool. |
| CHAIN_TYPE | BTC, BCH, UBTC | No default value, you must define it. | Blockchain's type that you want to BTCPool linking to. |
| CHAIN_SRC_ROOT | A path of dir, such as `/work/bitcoin`. | No default value, you must define it. | The path of blockchain's source code that you want to BTCPool linking to. |
| OPENSSL_ROOT_DIR | A path of dir, such as `/usr/local/opt/openssl`. | No definition is required by default, and cmake will automatically look for it. | The path of `openssl`'s source code. The macOS user may need to define it if cmake cannot find it automatically. |
| POOL__WORK_WITH_STRATUM_SWITCHER | ON, OFF | OFF | Build a special version of pool's stratum server, so you can run it with a stratum switcher. See also: [Stratum Switcher](https://github.com/btccom/stratumSwitcher). |
| POOL__INSTALL_PREFIX | A path of dir, such as `/work/btcpool.btc`. | /work/bitcoin.\[btc\|bch\|ubtc\] | The install path of `make install`. The deb package that generated by `make package` will install to the same path. |
| POOL__GENERATE_DEB_PACKAGE | ON, OFF | OFF | When it enabled, you can generate a deb package with `make package`. |

#### Building commands (example)

**build BTCPool that linking to Bitcoin**

```bash
mkdir /work
cd /work
wget -O bitcoin-0.16.0rc1.tar.gz https://github.com/bitcoin/bitcoin/archive/v0.16.0rc1.tar.gz
tar zxf bitcoin-0.16.0rc1.tar.gz

git clone https://github.com/bitcoin/bitcoin.git
cd btcpool
mkdir build
cd build

# Release build with 4 jobs:
cmake -DJOBS=4 -DCHAIN_TYPE=BTC -DCHAIN_SRC_ROOT=/work/bitcoin-0.16.0rc1 ..
make -j4

# Release build at macOS:
cmake -DCHAIN_TYPE=BTC -DCHAIN_SRC_ROOT=/work/bitcoin-0.16.0rc1 -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl ..
make

# Debug build:
cmake -DCMAKE_BUILD_TYPE=Debug -DCHAIN_TYPE=BTC -DCHAIN_SRC_ROOT=/work/bitcoin-0.16.0rc1 ..
make

# Build a special version of pool's stratum server, so you can run it with a stratum switcher:
cmake -DJOBS=4 -DCHAIN_TYPE=BTC -DCHAIN_SRC_ROOT=/work/bitcoin-0.16.0rc1 -DPOOL__WORK_WITH_STRATUM_SWITCHER=ON ..
make -j4
```

**build BTCPool that linking to BitcoinCash**

```bash
mkdir /work
cd /work
wget -O bitcoin-abc-0.16.2.tar.gz https://github.com/Bitcoin-ABC/bitcoin-abc/archive/v0.16.2.tar.gz
tar zxf bitcoin-abc-0.16.2.tar.gz

git clone https://github.com/btccom/btcpool.git
cd btcpool
mkdir build
cd build

# Release build with 4 jobs:
cmake -DJOBS=4 -DCHAIN_TYPE=BCH -DCHAIN_SRC_ROOT=/work/bitcoin-abc-0.16.2 ..
make -j4

# Release build at macOS:
cmake -DCHAIN_TYPE=BCH -DCHAIN_SRC_ROOT=/work/bitcoin-abc-0.16.2 -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl ..
make

# Debug build:
cmake -DCMAKE_BUILD_TYPE=Debug -DCHAIN_TYPE=BCH -DCHAIN_SRC_ROOT=/work/bitcoin-abc-0.16.2 ..
make

# Build a special version of pool's stratum server, so you can run it with a stratum switcher:
cmake -DJOBS=4 -DCHAIN_TYPE=BCH -DCHAIN_SRC_ROOT=/work/bitcoin-abc-0.16.2 -DPOOL__WORK_WITH_STRATUM_SWITCHER=ON ..
make -j4
```

**build BTCPool that linking to UnitedBitcoin**

```bash
mkdir /work
cd /work
wget -O UnitedBitcoin-1.0.7.0.tar.gz https://github.com/UnitedBitcoin/UnitedBitcoin/archive/v1.0.7.0.tar.gz
tar zxf UnitedBitcoin-1.0.7.0.tar.gz

# install libdb that UnitedBitcoin's wallet required
apt-get install -y software-properties-common
add-apt-repository -y ppa:bitcoin/bitcoin
apt-get -y update
apt-get install -y libdb4.8-dev libdb4.8++-dev

# UnitedBitcoin will build failed with `--disable-wallet`, so we have to build it manually with wallet
cd UnitedBitcoin-1.0.7.0
./autogen.sh
./configure --disable-bench --disable-tests
make -j4

cd ..
git clone https://github.com/btccom/btcpool.git
cd btcpool
mkdir build
cd build

# Release build with 4 jobs:
cmake -DJOBS=4 -DCHAIN_TYPE=UBTC -DCHAIN_SRC_ROOT=/work/UnitedBitcoin-1.0.7.0 ..
make -j4

# Release build at macOS:
cmake -DCHAIN_TYPE=UBTC -DCHAIN_SRC_ROOT=/work/UnitedBitcoin-1.0.7.0 -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl ..
make

# Debug build:
cmake -DCMAKE_BUILD_TYPE=Debug -DCHAIN_TYPE=UBTC -DCHAIN_SRC_ROOT=/work/UnitedBitcoin-1.0.7.0 ..
make

# Build a special version of pool's stratum server, so you can run it with a stratum switcher:
cmake -DJOBS=4 -DCHAIN_TYPE=UBTC -DCHAIN_SRC_ROOT=/work/UnitedBitcoin-1.0.7.0 -DPOOL__WORK_WITH_STRATUM_SWITCHER=ON ..
make -j4
```

**build libethash**

```bash
cd /work/btcpool/build
mkdir /libethash
cmake ../src/libethash
make install
```

---

## Init btcpool

Now create folder for btcpool, if you are going to run all service in one machine you could run `install/init_folders.sh` as below.

```
cd /work/btcpool/build
bash ../install/init_folders.sh
```

**create kafka topics**

Login to one of kafka machines, than create topics for `btcpool`:

```bash
cd /work/kafka

# "10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181" at below is ZooKeeper cluster.
```

Topics for Bitcoin or BitcoinCash
```bash
# For compatibility with old deployments, topics of BTCPool for Bitcoin and BitcoinCash have the same names.
# So we cannot share the same kafka cluster with these two blockchains.
./bin/kafka-topics.sh --create --topic RawGbt         --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic StratumJob     --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1 
./bin/kafka-topics.sh --create --topic SolvedShare    --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 3 --partitions 1 
./bin/kafka-topics.sh --create --topic ShareLog       --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic NMCAuxBlock    --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic NMCSolvedShare --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic CommonEvents   --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1

# do not keep 'RawGbt' message more than 6 hours
./bin/kafka-topics.sh --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --alter --topic RawGbt       --config retention.ms=21600000
# 'CommonEvents': 12 hours
./bin/kafka-topics.sh --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --alter --topic CommonEvents --config retention.ms=43200000
```

Topics for UnitedBitcoin
```bash
# For compatibility with old deployments, topics of BTCPool for Bitcoin and BitcoinCash have the same names.
# So we cannot share the same kafka cluster with these two blockchains.
./bin/kafka-topics.sh --create --topic UBTC_RawGbt         --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic UBTC_StratumJob     --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1 
./bin/kafka-topics.sh --create --topic UBTC_SolvedShare    --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 3 --partitions 1 
./bin/kafka-topics.sh --create --topic UBTC_ShareLog       --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic UBTC_NMCAuxBlock    --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic UBTC_NMCSolvedShare --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1
./bin/kafka-topics.sh --create --topic UBTC_CommonEvents   --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --replication-factor 2 --partitions 1

# do not keep 'RawGbt' message more than 6 hours
./bin/kafka-topics.sh --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --alter --topic UBTC_RawGbt       --config retention.ms=21600000
# 'CommonEvents': 12 hours
./bin/kafka-topics.sh --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181 --alter --topic UBTC_CommonEvents --config retention.ms=43200000
```

Check kafka topics stutus:

```
# show topics
$ ./bin/kafka-topics.sh --describe --zookeeper 10.0.0.1:2181,10.0.0.2:2181,10.0.0.3:2181

# if create all topics success, will output:
Topic:RawGbt   	PartitionCount:1       	ReplicationFactor:2    	Configs:
       	Topic: RawGbt  	Partition: 0   	Leader: 1      	Replicas: 1,2  	Isr: 1,2
Topic:ShareLog 	PartitionCount:1       	ReplicationFactor:2    	Configs:
       	Topic: ShareLog	Partition: 0   	Leader: 2      	Replicas: 2,1  	Isr: 2,1
Topic:SolvedShare      	PartitionCount:1       	ReplicationFactor:3    	Configs:
       	Topic: SolvedShare     	Partition: 0   	Leader: 1      	Replicas: 1,2,3	Isr: 1,2,3
Topic:StratumJob       	PartitionCount:1       	ReplicationFactor:2    	Configs:
       	Topic: StratumJob      	Partition: 0   	Leader: 1      	Replicas: 1,2  	Isr: 1,2
Topic:NMCAuxBlock        PartitionCount:1         ReplicationFactor:3      Configs:
         Topic: NMCAuxBlock       Partition: 0     Leader: 3        Replicas: 3,1  Isr: 3,1
Topic:NMCSolvedShare     PartitionCount:1         ReplicationFactor:3      Configs:
         Topic: NMCSolvedShare    Partition: 0     Leader: 3        Replicas: 3,1  Isr: 3,1
```

Before you start btcpool's services, you need to stetup MySQL database and bitcoind/namecoind (if enable merged mining).

Init MySQL database tables.

```
#
# create database `bpool_local_db` and `bpool_local_stats_db`
#

#
# than create tables from sql
#
# bpool_local_db
mysql -uxxxx -p -h xxx.xxx.xxx bpool_local_db       < install/bpool_local_db.sql

# bpool_local_stats_db
mysql -uxxxx -p -h xxx.xxx.xxx bpool_local_stats_db < install/bpool_local_stats_db.sql

```

**User list API** 

You need to implement a HTTP API for stratum server. The API is use to fetch user list in incremental model. Stratum Server will call this API every few seconds, interval is about 10 seconds. When Stratum Server start, it will fetch again and again util no more users.

Should works as below.

```
#
# `last_id` is the offset. pagesize is 5. total user count is 8.
#
$ curl http://xxx.xxx.xxx/GetUserList?last_id=0
{"err_no":0,"err_msg":null,"data":{"litianzhao":1,"spica":2,"fazhu":3,"kevin":4,"kevin1":5}}

# fetch next page
$ curl http://xxx.xxx.xxx/GetUserList?last_id=5
{"err_no":0,"err_msg":null,"data":{"kevin2":6,"kevin3":7,"Miles":8}}

# fetch next page, no more users
$ curl http://xxx.xxx.xxx/GetUserList?last_id=8
{"err_no":0,"err_msg":null,"data":{}}
```

Use `supervisor` to manager services.


```
apt-get install supervisor

#
# change open file limits, vim /etc/supervisor/supervisord.conf
# in the [supervisord] section, add 'minfds=65535'.
# $ service supervisor restart
#
cd /work/btcpool/build


################################################################################
# for common server
################################################################################
cp ../install/supervisord/gbtmaker.conf      /etc/supervisor/conf.d
cp ../install/supervisord/jobmaker.conf      /etc/supervisor/conf.d
cp ../install/supervisord/blkmaker.conf      /etc/supervisor/conf.d
cp ../install/supervisord/sharelogger.conf   /etc/supervisor/conf.d
#
# if you need to enable watch other pool's stratum job. poolwatcher will 
# generate empty getblocktemplate when they find a new height stratum job 
# from other pools. this could reduce pool's orphan block rate.
#
cp ../install/supervisord/poolwatcher.conf   /etc/supervisor/conf.d
#
# enable namecoin merged mining
#
cp ../install/supervisord/nmcauxmaker.conf   /etc/supervisor/conf.d

#
# start services: gbtmaker, jobmaker, blkmaker, sharelogger...
#
$ supervisorctl
> reread
> update
> status


#
# start your stratum server(see below) and add some miners to the pool, after make
# some shares than start 'slparser' & 'statshttpd'
#
cp ../install/supervisord/slparser.conf      /etc/supervisor/conf.d
cp ../install/supervisord/statshttpd.conf    /etc/supervisor/conf.d

# start services: slparser, statshttpd
$ supervisorctl
> reread
> update
> status


################################################################################
# for stratum server
################################################################################
cp ../install/supervisord/sserver.conf       /etc/supervisor/conf.d

$ supervisorctl
> reread
> update
> status
```

## Upgrade btcpool

Check release note and upgrade guide. Maybe add some config options to config file or change something of database table. 

Get the latest codes and rebuild:

```
cd /work/btcpool/build
git pull
cmake ..
make
```

use `supervisorctl` to restart your services:

```
$ supervisorctl
> restart xxxx
```
